<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»å‹™ä½ˆå‘Šæ¬„</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* --- æ¨£å¼è¨­å®š (RPG é¢¨æ ¼) --- */
        :root { --bg: #202020; --board: #8b4513; --paper: #f4e4bc; --accent: #e74c3c; }
        body {
            background: var(--bg); font-family: 'Press Start 2P', cursive; color: white;
            display: flex; flex-direction: column; align-items: center; padding: 20px;
        }
        h1 { text-shadow: 3px 3px 0 #000; font-size: 20px; text-align: center; margin-bottom: 30px; }
        
        /* è¼¸å…¥å€ */
        .panel {
            background: #333; border: 4px solid #fff; padding: 20px; width: 90%; max-width: 500px;
            box-shadow: 6px 6px 0 #000; margin-bottom: 30px;
        }
        input, button {
            width: 100%; padding: 10px; margin-bottom: 10px; background: #000; border: 2px solid #0f0;
            color: #0f0; font-family: inherit; box-sizing: border-box; font-size: 12px;
        }
        button {
            background: var(--accent); color: #fff; border: 4px solid #fff; cursor: pointer;
            box-shadow: 3px 3px 0 #000; margin-top: 10px;
        }
        button:active { transform: translate(3px, 3px); box-shadow: none; }
        button:disabled { background: #555; cursor: wait; }

        /* ä½ˆå‘Šæ¬„ */
        #board {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; max-width: 1000px;
            background: var(--board); padding: 20px; border: 8px solid #5a3010; min-height: 300px;
            box-shadow: inset 0 0 20px #000;
        }
        .paper {
            background: var(--paper); color: #2c1810; width: 220px; padding: 15px;
            box-shadow: 4px 4px 8px rgba(0,0,0,0.6); position: relative; font-family: sans-serif;
            transform: rotate(var(--rot)); transition: transform 0.2s; word-break: break-all;
        }
        .paper:hover { transform: scale(1.1) rotate(0deg); z-index: 10; border: 2px solid white; }
        .pin { width: 10px; height: 10px; background: #c0392b; border-radius: 50%; position: absolute; top: 5px; left: 50%; transform: translateX(-50%); }
        .content { font-weight: bold; margin-top: 15px; white-space: pre-wrap; }
        img.preview { max-width: 100%; border: 2px solid #5a3010; margin-top: 10px; display: block; }
        .link-btn { display: inline-block; background: #5a3010; color: #fff; text-decoration: none; padding: 3px 8px; margin-top: 8px; font-size: 12px; border-radius: 4px; }
        .loading { font-size: 10px; color: yellow; text-align: center; display: none; margin-top: 5px;}
    </style>
</head>
<body>

    <h1>ğŸ›¡ï¸ ä»»å‹™ä½ˆå‘Šæ¬„ ğŸ›¡ï¸</h1>

    <div class="panel">
        <div>ä»»å‹™å…§å®¹ (æ–‡å­—):</div>
        <input type="text" id="msg" placeholder="è¼¸å…¥æ–‡å­—...">
        
        <div>ä¸Šå‚³æ²è»¸ (åœ–ç‰‡/æª”æ¡ˆ):</div>
        <input type="file" id="file">
        
        <div>å‚³é€é–€ (ç¶²å€):</div>
        <input type="text" id="link" placeholder="https://...">

        <button onclick="submitData()" id="btn">ç™¼ä½ˆå…¬å‘Š</button>
        <div class="loading" id="status">å‚³é€è³‡æ–™ä¸­...å²èŠå§†æ¬é‹è¼ƒæ…¢è«‹ç¨å€™...</div>
    </div>

    <div id="board">
        <div style="color:white; margin-top: 50px;">è®€å–å…¬æœƒç´€éŒ„ä¸­...</div>
    </div>

    <script>
        // â–¼â–¼â–¼ è«‹å°‡ä¸‹æ–¹å¼•è™Ÿå…§çš„ç¶²å€æ›æˆä½ çš„ Web App URL â–¼â–¼â–¼
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwTLs7XT7ZoC49RUD0tqz7VcfKOrylNiohD7oLoZwnb0c3rRysA29GiDCBbnwAT8joZDw/exec";
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const board = document.getElementById('board');
        const statusDiv = document.getElementById('status');
        const btn = document.getElementById('btn');

        // 1. åˆå§‹åŒ–ï¼šè®€å–è³‡æ–™
        window.onload = function() {
            fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                board.innerHTML = ''; // æ¸…ç©ºè®€å–è¨Šæ¯
                if(data.length === 0) board.innerHTML = '<div style="color:white">ç›®å‰ç„¡ä»»å‹™...</div>';
                data.forEach(item => createPost(item));
            })
            .catch(err => {
                console.error(err);
                board.innerHTML = '<div style="color:red">ç„¡æ³•é€£çµå…¬æœƒç¸½éƒ¨ (è«‹æª¢æŸ¥ç¶²å€è¨­å®š)</div>';
            });
        };

        // 2. ç™¼é€è³‡æ–™
        function submitData() {
            const msg = document.getElementById('msg').value;
            const link = document.getElementById('link').value;
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];

            if (!msg && !file && !link) return alert("è«‹è¼¸å…¥å…§å®¹ï¼");

            // UI é–å®š
            btn.disabled = true;
            statusDiv.style.display = 'block';

            // æº–å‚™è³‡æ–™
            const payload = {
                msg: msg,
                link: link,
                fileName: file ? file.name : "",
                fileMimeType: file ? file.type : "",
                fileData: "" // å¾…æœƒå¡«å…¥
            };

            // å¦‚æœæœ‰æª”æ¡ˆï¼Œè½‰æˆ Base64 å†å‚³
            if (file) {
                // é™åˆ¶æª”æ¡ˆå¤§å° (Google Script é™åˆ¶ç´„ 5MBï¼Œå®‰å…¨èµ·è¦‹è¨­ 3MB)
                if(file.size > 3 * 1024 * 1024) {
                    alert("æª”æ¡ˆå¤ªå¤§å›‰ï¼è«‹å°æ–¼ 3MB");
                    resetUI();
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    payload.fileData = e.target.result; // Base64 å­—ä¸²
                    sendToGoogle(payload);
                };
                reader.readAsDataURL(file);
            } else {
                sendToGoogle(payload);
            }
        }

        function sendToGoogle(payload) {
            // ä½¿ç”¨ text/plain é¿å… CORS é æª¢è«‹æ±‚ (Google Script ç‰¹æ€§)
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(response => {
                if(response.status === 'success') {
                    // æˆåŠŸå¾Œç›´æ¥åœ¨ç•«é¢ä¸Šæ–°å¢ä¸€ç­†ï¼Œä¸ç”¨é‡æ•´
                    createPost({
                        msg: payload.msg,
                        link: payload.link,
                        fileUrl: response.fileUrl,
                        fileType: (payload.fileMimeType || "").startsWith('image') ? 'image' : (payload.fileData ? 'file' : 'text')
                    }, true);
                    
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('msg').value = "";
                    document.getElementById('link').value = "";
                    document.getElementById('file').value = "";
                } else {
                    alert("ä¸Šå‚³å¤±æ•—ï¼š" + response.message);
                }
                resetUI();
            })
            .catch(err => {
                console.error(err);
                alert("å‚³é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                resetUI();
            });
        }

        function resetUI() {
            btn.disabled = false;
            statusDiv.style.display = 'none';
        }

        function createPost(data, isNew = false) {
            const div = document.createElement('div');
            div.className = 'paper';
            div.style.setProperty('--rot', (Math.random()*6 - 3) + 'deg');

            let html = `<div class="pin"></div>`;
            if(data.msg) html += `<div class="content">${escapeHtml(data.msg)}</div>`;
            
            if(data.fileType === 'image' && data.fileUrl) {
                html += `<img src="${data.fileUrl}" class="preview">`;
            } else if (data.fileType === 'file' && data.fileUrl) {
                html += `<a href="${data.fileUrl}" target="_blank" class="link-btn">ğŸ“„ ä¸‹è¼‰æª”æ¡ˆ</a>`;
            }

            if(data.link) {
                html += `<br><a href="${data.link}" target="_blank" class="link-btn">ğŸ”— é€£çµ</a>`;
            }

            div.innerHTML = html;
            
            if(isNew) {
                board.insertBefore(div, board.firstChild);
            } else {
                board.appendChild(div);
            }
        }

        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }
    </script>
</body>
</html>
