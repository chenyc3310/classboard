<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»å‹™ä½ˆå‘Šæ¬„</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #202020; --board: #8b4513; --paper: #f4e4bc; --accent: #e74c3c; }
        body { background: var(--bg); font-family: 'Press Start 2P', cursive; color: white; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        h1 { text-shadow: 3px 3px 0 #000; font-size: 20px; text-align: center; margin-bottom: 30px; }
        
        .panel { background: #333; border: 4px solid #fff; padding: 20px; width: 90%; max-width: 500px; box-shadow: 6px 6px 0 #000; margin-bottom: 30px; }
        .row { margin-bottom: 10px; }
        label { display: block; color: #0f0; font-size: 10px; margin-bottom: 5px; }
        input, button { width: 100%; padding: 10px; background: #000; border: 2px solid #0f0; color: #0f0; font-family: inherit; box-sizing: border-box; font-size: 12px; }
        
        button { background: var(--accent); color: #fff; border: 4px solid #fff; cursor: pointer; box-shadow: 3px 3px 0 #000; margin-top: 10px; }
        button:active { transform: translate(3px, 3px); box-shadow: none; }
        button:disabled { background: #555; cursor: wait; }

        #board { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; max-width: 1000px; background: var(--board); padding: 20px; border: 8px solid #5a3010; min-height: 300px; box-shadow: inset 0 0 20px #000; }
        
        .paper { background: var(--paper); color: #2c1810; width: 220px; padding: 15px; box-shadow: 4px 4px 8px rgba(0,0,0,0.6); position: relative; font-family: sans-serif; transform: rotate(var(--rot)); transition: transform 0.2s; word-break: break-all; }
        .paper:hover { transform: scale(1.1) rotate(0deg); z-index: 10; border: 2px solid white; }
        .pin { width: 10px; height: 10px; background: #c0392b; border-radius: 50%; position: absolute; top: 5px; left: 50%; transform: translateX(-50%); }
        .content { font-weight: bold; margin-top: 15px; white-space: pre-wrap; }
        img.preview { max-width: 100%; border: 2px solid #5a3010; margin-top: 10px; display: block; }
        .link-btn { display: inline-block; background: #5a3010; color: #fff; text-decoration: none; padding: 3px 8px; margin-top: 8px; font-size: 12px; border-radius: 4px; }
        
        /* åƒåœ¾æ¡¶æŒ‰éˆ• */
        .del-btn { 
            position: absolute; bottom: 5px; right: 5px; 
            background: transparent; border: none; color: #c0392b; 
            font-size: 18px; cursor: pointer; opacity: 0.6; box-shadow: none; margin-top: 0; padding: 0; width: auto;
        }
        .del-btn:hover { opacity: 1; transform: scale(1.2); }

        .loading { font-size: 10px; color: yellow; text-align: center; display: none; margin-top: 5px;}
    </style>
</head>
<body>

    <h1>ğŸ“œ ä»»å‹™ä½ˆå‘Šæ¬„ ğŸ“œ</h1>

    <div class="panel">
        <div class="row">
            <label>1. ä»»å‹™å…§å®¹ (æ–‡å­—):</label>
            <input type="text" id="msg" placeholder="è¼¸å…¥æ–‡å­—...">
        </div>
        <div class="row">
            <label>2. ä¸Šå‚³æ²è»¸ (åœ–ç‰‡/æª”æ¡ˆ):</label>
            <input type="file" id="file">
        </div>
        <div class="row">
            <label>3. å‚³é€é–€ (é€£çµ):</label>
            <input type="text" id="link" placeholder="https://...">
        </div>

        <button onclick="submitData()" id="btn">ç™¼ä½ˆå…¬å‘Š</button>
        <div class="loading" id="status">â³ æ­£åœ¨é£›é´¿å‚³æ›¸çµ¦å…¬æœƒç¸½éƒ¨...</div>
    </div>

    <div id="board">
        <div style="color:white; margin-top: 50px;">è®€å–å…¬æœƒç´€éŒ„ä¸­...</div>
    </div>

    <script>
        // â–¼â–¼â–¼ è«‹è¨˜å¾—æ›æˆä½ çš„ Apps Script ç¶²å€ â–¼â–¼â–¼
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwTLs7XT7ZoC49RUD0tqz7VcfKOrylNiohD7oLoZwnb0c3rRysA29GiDCBbnwAT8joZDw/exec"; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const board = document.getElementById('board');
        const statusDiv = document.getElementById('status');
        const btn = document.getElementById('btn');

        window.onload = function() {
            fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                board.innerHTML = '';
                if(data.length === 0) board.innerHTML = '<div style="color:white">ç›®å‰ç„¡ä»»å‹™...</div>';
                data.forEach(item => createPost(item));
            })
            .catch(err => {
                console.error(err);
                board.innerHTML = '<div style="color:red">ç„¡æ³•é€£çµå…¬æœƒç¸½éƒ¨</div>';
            });
        };

        function submitData() {
            const msg = document.getElementById('msg').value;
            const link = document.getElementById('link').value;
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];

            if (!msg && !file && !link) return alert("è«‹è¼¸å…¥å…§å®¹ï¼");

            btn.disabled = true;
            statusDiv.style.display = 'block';

            const payload = {
                action: "upload",
                msg: msg,
                link: link,
                fileName: file ? file.name : "",
                fileMimeType: file ? file.type : "",
                fileData: ""
            };

            if (file) {
                if(file.size > 3 * 1024 * 1024) {
                    alert("æª”æ¡ˆå¤ªå¤§å›‰ï¼è«‹å°æ–¼ 3MB");
                    resetUI();
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    payload.fileData = e.target.result;
                    sendToGoogle(payload);
                };
                reader.readAsDataURL(file);
            } else {
                sendToGoogle(payload);
            }
        }

        function sendToGoogle(payload) {
            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(response => {
                if(response.status === 'success') {
                    location.reload(); 
                } else {
                    alert("ä¸Šå‚³å¤±æ•—ï¼š" + response.message);
                    resetUI();
                }
            })
            .catch(err => {
                console.error(err);
                alert("å‚³é€å¤±æ•—");
                resetUI();
            });
        }

        // åˆªé™¤åŠŸèƒ½ (ç„¡å¯†ç¢¼ç‰ˆ)
        function requestDelete(uid) {
            // è·³å‡ºç¢ºèªè¦–çª—ï¼Œä»¥å…èª¤åˆª
            if (!confirm("ç¢ºå®šè¦æ’•æ¯€é€™å¼µå§”è¨—å–®å—ï¼Ÿ(åˆªé™¤å¾Œç„¡æ³•å¾©åŸ)")) return;

            btn.disabled = true;
            statusDiv.innerText = "æ­£åœ¨æ–½å±•æ¶ˆé™¤é­”æ³•...";
            statusDiv.style.display = 'block';

            const payload = {
                action: "delete",
                uid: uid
            };

            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(response => {
                if(response.status === 'success') {
                    alert("ğŸ—‘ï¸ ä»»å‹™å·²åˆªé™¤ï¼");
                    location.reload(); 
                } else {
                    alert("âŒ åˆªé™¤å¤±æ•—ï¼š" + response.message);
                    resetUI();
                }
            })
            .catch(err => {
                alert("é€£ç·šéŒ¯èª¤");
                resetUI();
            });
        }

        function resetUI() {
            btn.disabled = false;
            statusDiv.style.display = 'none';
            statusDiv.innerText = "â³ æ­£åœ¨é£›é´¿å‚³æ›¸çµ¦å…¬æœƒç¸½éƒ¨...";
        }

        // é€™æ˜¯é˜²å½ˆç‰ˆçš„å»ºç«‹è²¼æ–‡åŠŸèƒ½
        function createPost(data) {
            // â˜… é€™è¡Œæ˜¯é˜²è­·ç½©çš„é–‹å§‹ï¼šå˜—è©¦åŸ·è¡Œ
            try {
                const div = document.createElement('div');
                div.className = 'paper';
                div.style.setProperty('--rot', (Math.random()*6 - 3) + 'deg');

                let html = `<div class="pin"></div>`;
                
                if (data.uid) {
                    html += `<button class="del-btn" onclick="requestDelete('${data.uid}')" title="åˆªé™¤ä»»å‹™">ğŸ—‘ï¸</button>`;
                }

                // é€™è£¡æˆ‘å€‘åŠ ä¸Šäº† String(...) ç¢ºä¿ä¸€å®šæ˜¯æ–‡å­—ï¼Œé€™å°±æ˜¯æ˜¨å¤©ç•¶æ©Ÿçš„è§£è—¥
                if(data.msg) html += `<div class="content">${escapeHtml(String(data.msg))}</div>`;
                
                if(data.fileType === 'image' && data.fileUrl) {
                    html += `<img src="${data.fileUrl}" class="preview">`;
                } else if (data.fileType === 'file' && data.fileUrl) {
                    html += `<a href="${data.fileUrl}" target="_blank" class="link-btn">ğŸ“„ ä¸‹è¼‰æª”æ¡ˆ</a>`;
                }

                if(data.link) {
                    html += `<br><a href="${data.link}" target="_blank" class="link-btn">ğŸ”— é€£çµ</a>`;
                }

                div.innerHTML = html;
                board.appendChild(div);

            } catch (error) {
                // â˜… é€™è¡Œæ˜¯é˜²è­·ç½©çš„çµå°¾ï¼šå¦‚æœä¸Šé¢å‡ºéŒ¯ï¼Œé›»è…¦æœƒä¾†åˆ°é€™è£¡
                // æˆ‘å€‘å‘Šè¨´é›»è…¦ï¼šä¸è¦ç•¶æ©Ÿï¼Œåªè¦åœ¨å¾Œå°å·å·ç´€éŒ„éŒ¯èª¤å°±å¥½ï¼Œç„¶å¾Œç¹¼çºŒåšä¸‹ä¸€ä»¶äº‹
                console.error("ç™¼ç¾ä¸€å‰‡æœ‰å•é¡Œçš„è²¼æ–‡ï¼Œå·²è‡ªå‹•è·³éï¼ŒéŒ¯èª¤åŸå› ï¼š", error);
            }
        }
    </script>
</body>
</html>
